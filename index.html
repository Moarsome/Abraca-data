<!DOCTYPE html>
<html lang="en">

<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
      <style>
        :root {
            background-color: white;
        }
    
        body {
            font-family: Arial, Helvetica, sans-serif;
            font-size: medium;
            word-spacing: 10px;
            margin: 0;
        }
    
        a {
            color: inherit;
            text-decoration: none;
        }
        
        img {
            width: 80%;
            height: 80%;
        }

        .top-title {
            margin: auto;
            margin-top: 10px;
            color: black;
            text-align: center;
            align-items: center;
            width: 300px;
        }
    
        .main {
            display: flex;
            flex-direction: row;
            justify-content: flex-start;
            font-size: medium;
            margin-top: 20px;
        }
    
        .main-title {
            border-radius: 10%;
        }

        .temp-chart {
            display: flex;
            position: relative;
            width: 50vw;
            height: 30vh;
        }
        </style>
</head>

<body>
    <div class="top-title">
        <img src="https://www.lassoo.co.nz/wp-content/uploads/2020/08/electric-kiwi-1.png">
    </div>

    <div class="temp-chart">
        <canvas id="myChart"></canvas>
    </div>

    <script type="text/javascript">

        function getHour(unix) {
            intUnix = parseInt(unix);
            var date = new Date(unix * 1000);
            return date.getHours();
        }
        // Document ready start the script
        document.addEventListener('DOMContentLoaded', function (event) {
            // Retrieve the access token from local storage
            let token = apiProvider.getAccessToken();

            let openWeatherKey = "1c69bc2783cad2acbebae2820882055b";

            // Redirect to auth route if token is not retrieved
            if (token == null) {
                window.location.href = "/auth";
                return;
            }

            // Make an API call to /session
            let sessionResp = httpGet(`${API_URL}/session/`, token);

            // Parse response to json format
            let jsonSession = JSON.parse(sessionResp);

            // Extract first customer information from session response
            let customer = jsonSession["data"]["customer"][0];
            let connectionId = customer["connection"]["connection_id"];
            let customerNumber = customer["customer_number"];

            // ASSUME today's date is 2021-08-23
            let groupBy = "day";
            let todayDate = "2021-08-23";
            let lastWeekDate = todayDate.substring(todayDate.lastIndexOf("-") + 1) - "7"; // 7 days ago
            let previousDate = todayDate.substring(0, todayDate.lastIndexOf("-") + 1) + lastWeekDate;

            // Make an API call to /consumption/averages
            let consumptionAvg = httpGet(`${API_URL}/consumption/averages/${customerNumber}/${connectionId}/?start_date=${previousDate}&end_date=${previousDate}&group_by=${groupBy}`, token);

            // Parse response to json format to display nicely.
            let jsonConsumption = JSON.parse(consumptionAvg);

            // Make API call to /hop
            let hopResp = httpGet(`${API_URL}/hop/`, token);

            // Parse hop and display
            let jsonHop = JSON.parse(hopResp);

            parseHop(jsonHop,jsonConsumption, previousDate);

            // Find user city
            let userAddress = customer["connection"]["address"];
            let userCity = userAddress.substring(0, userAddress.lastIndexOf(","));
            userCity = userCity.substring(userCity.lastIndexOf(",") + 2);

            // Insert city into OpenWeatherAPI
            let geoData = openWeatherGet(`http://api.openweathermap.org/geo/1.0/direct?q=${userCity}&limit=1&appid=${openWeatherKey}`);
            let jsonGeo = JSON.parse(geoData);

            // Retrieve latitude and longitude from geographic data
            let lat = jsonGeo[0]["lat"];
            let lon = jsonGeo[0]["lon"];

            let weatherData = openWeatherGet(`https://api.openweathermap.org/data/2.5/onecall?lat=${lat}&lon=${lon}&exclude=minutely,current,daily&units=metric&appid=${openWeatherKey}`);
            let jsonWeather = JSON.parse(weatherData);

            // Loop through times
            parseWeather(jsonWeather);

            createChart(getTempData(),getTimeData());
        });
    </script>

    <script type="text/javascript" src="/main.js"></script>   

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script type="text/javascript" src="/graph.js"></script>

    <script type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/oauth2-client-js@0.0.15/dist/oauth2-client.js"></script>
    <!-- Load the config variables-->
    <script type="text/javascript" src="/auth.js"></script>

</body>

</html>